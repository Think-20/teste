<div class="container-schedule">
  <div class="my-container">
    <h3 class="lead row">
      <div class="col-md-6">
        Cronograma -
        <span class="actualMonth" (click)="monthSelect.open()">
          {{ month.name }} {{ year }}
          <mat-select panelClass="select-month-panel" class="select-hidden col-md-3" #monthSelect>
            <mat-option *ngFor="let month of months" (click)="updateMonth(month)">{{month.name}}</mat-option>
          </mat-select>
        </span>
      </div>
      <div class="col-md-6 updated-message" *ngIf="dataInfo != null">
        <small>{{lastUpdateMessage}}</small>
      </div>
    </h3>
  </div>
  <div class="col-md-12" id="searchForm">
    <form [formGroup]="searchForm" autocomplete="off">
      <mat-card-title class="header-form">
        <div class="row search-bar-group">
          <div class="title">
            Lista
          </div>
          <mat-form-field class="bar">
            <input #search matInput formControlName="search" placeholder="Qual job você procura?" autocomplete="off">
          </mat-form-field>
          <div class="buttons">
            <a mat-button (click)="search.focus()">
              <mat-icon>search</mat-icon>
            </a>
            <a mat-button (click)="filter = filter ? false : true">
              <mat-icon>keyboard_arrow_down</mat-icon>
            </a>
            <a [routerLink]="['new']" mat-button>
              <mat-icon>add</mat-icon>
            </a>
          </div>
        </div>
      </mat-card-title>
    </form>
    <mat-menu #menu="matMenu">
      <ng-template matMenuContent let-task="task" let-chrono="chrono">
        <div *ngIf="jobDisplay(task, chrono) != 'Continuação auto.'">
          <a *ngIf="task.job.id == undefined" (click)="addTask(chrono.day)" mat-menu-item>
            <mat-icon>add</mat-icon> Adicionar
          </a>
          <a [disabled]="!permissionVerify('show', task.job)" *ngIf="task.job.id != undefined" [routerLink]="['/jobs/show', task.job.id]"
            mat-menu-item>
            <mat-icon>subject</mat-icon> Visualização
          </a>
          <a [disabled]="!permissionVerify('task.edit', task.job)" *ngIf="task.id != undefined" [routerLink]="['/schedule/edit', task.id]"
            mat-menu-item>
            <mat-icon>mode_edit</mat-icon> Editar tarefa
          </a>
          <a [disabled]="!permissionVerify('edit', task.job)" *ngIf="task.job.id != undefined" [routerLink]="['/jobs/edit', task.job.id]"
            mat-menu-item>
            <mat-icon>mode_edit</mat-icon> Editar job
          </a>
          <a [disabled]="!permissionVerify('edit', task.job)" *ngIf="task.job.id != undefined && (task.job.status?.id == 5 || task.job.status?.id == 1)"
            (click)="signal(task)" mat-menu-item>
            <span *ngIf="task.job.status?.id == 1">
              <mat-icon>flag</mat-icon> Sinalizar
            </span>
            <span *ngIf="task.job.status?.id == 5">
              <mat-icon>outlined_flag</mat-icon> Remover sinalização
            </span>
          </a>
          <button [disabled]="!permissionVerify('delete', task.job)" *ngIf="task.job.id != undefined" (click)="delete(task)" mat-menu-item>
            <mat-icon>delete</mat-icon> Remover
          </button>
        </div>
      </ng-template>
    </mat-menu>
    <mat-card class="schedule-card">
      <table class="table mat-table schedule-table">
        <div class="mat-header-row">
          <div class="mat-header-cell mat-column-date">Data</div>
          <div class="mat-header-cell mat-column-creation">Respons.</div>
          <div class="mat-header-cell mat-column-job">Job</div>
          <div class="mat-header-cell mat-column-type">Tipo</div>
          <div class="mat-header-cell mat-column-client">Cliente</div>
          <div class="mat-header-cell mat-column-agency">Agência</div>
          <div class="mat-header-cell mat-column-event">Evento</div>
          <div class="mat-header-cell mat-column-event-date">Data do evento</div>
          <div class="mat-header-cell mat-column-budget">Verba/Valor</div>
          <div class="mat-header-cell mat-column-area">Área</div>
          <div class="mat-header-cell mat-column-time">Prazo</div>
          <div class="mat-header-cell mat-column-deadline">Deadline</div>
          <div class="mat-header-cell mat-column-attendance">Atend.</div>
          <div class="mat-header-cell mat-column-stat">Status</div>
          <!--
            <div class="mat-header-cell mat-column-action">Ação</div>
            -->
        </div>
        <div class="mat-row-scroll">
          <div #list class="mat-row line-chrono" *ngFor="let chr of chrono; let i = index" [@rowAppeared]="rowAppearedState">
            <div class="mat-cell mat-column-date day-chrono day-{{ chr.day }} month-{{ chr.month }}">
              <div>
                <span>{{ chr.day }}-{{ chr.dayOfWeek?.abbrev }}</span>
                <button *ngIf="permissionVerify('new', job)" class="cb-button add-chrono" (click)="addTask(chr.day)">
                  EXTRA
                </button>
              </div>
            </div>
            <div class="line-jobs">
              <div class="line-job" [class.no-border]="['Projeto', 'Orçamento'].indexOf(chrono[i].tasks[y + 1]?.job_activity?.description) >= 0 && [5,3].indexOf(chrono[i].tasks[y + 1]?.job?.status_id) >= 0  && jobDisplay(task, chrono[i]) != 'Continuação auto.'"
                [class.signal]="task.job?.status?.id == 5 && (['Projeto', 'Orçamento'].indexOf(task.job_activity.description) >= 0) && jobDisplay(task, chrono[i]) != 'Continuação auto.'"
                [class.approved-budget]="task.job?.status?.id == 3 && (['Orçamento'].indexOf(task.job_activity.description) >= 0) && jobDisplay(task, chrono[i]) != 'Continuação auto.'"
                [class.approved-creation]="task.job?.status?.id == 3 && (['Projeto'].indexOf(task.job_activity.description) >= 0) && jobDisplay(task, chrono[i]) != 'Continuação auto.'"
                [class.other-attendance]="task.job?.attendance_id != authService.currentUser().employee.id && task.responsible_id != authService.currentUser().employee.id && task.job.id != undefined && !permissionVerify('edit', task.job)"
                [ngClass]="getLineClass(task, chrono[i].day, chrono[i].month)"
                *ngFor="let task of chrono[i].tasks; let y = index"
                [matMenuTriggerFor]="menu"
                [matMenuTriggerData]="{task: task, chrono: chrono[i]}"
                draggable="true">
                <div class="mat-cell mat-column-creation">
                  {{ task?.responsible?.name }}
                </div>
                <div class="mat-cell mat-column-job">
                  {{ jobDisplay(task, chrono[i]) }}
                </div>
                <div class="mat-cell mat-column-type">
                  {{ task.job.job_type?.description }}
                </div>
                <div class="mat-cell mat-column-client">
                  {{ task.job.client != null ? task.job.client.fantasy_name : task.job.not_client }}
                </div>
                <div class="mat-cell mat-column-agency">
                  {{ task.job.agency ? task.job.agency.fantasy_name : '' }}
                </div>
                <div class="mat-cell mat-column-event">
                  {{ task.job.event }}
                </div>
                <div class="mat-cell mat-column-event-date">
                  &nbsp;
                </div>
                <div class="mat-cell mat-column-budget">
                  {{ (canShowBudgetValue(task, chrono[i]) ? task.job.budget_value : '') | number: '1.2' }}
                </div>
                <div class="mat-cell mat-column-area">
                  &nbsp;
                </div>
                <div class="mat-cell mat-column-time">
                  {{ timeDisplay(task, chrono[i]) }}
                </div>
                <div class="mat-cell mat-column-deadline">
                  {{ task.job?.deadline | date:'dd/MM' }}
                </div>
                <div class="mat-cell mat-column-attendance">
                  {{ task.job?.attendance?.name }}
                </div>
                <div class="mat-cell mat-column-stat">
                  {{ task.job?.status?.description }}
                </div>
              </div>
            </div>
            <!--
              <div class="mat-cell mat-column-action">
                <mat-menu #menu="matMenu">
                  <a [routerLink]="['/jobs/show', task.job.id]" mat-menu-item>
                    <mat-icon>subject</mat-icon> Visualização
                  </a>
                  <a [routerLink]="['/jobs/edit', task.job.id]" mat-menu-item>
                    <mat-icon>mode_edit</mat-icon> Editar
                  </a>
                  <button (click)="delete(job)" mat-menu-item>
                    <mat-icon>delete</mat-icon> Remover
                  </button>
                </mat-menu>

                <button mat-icon-button [matMenuTriggerFor]="menu">
                  <mat-icon>menu</mat-icon>
                </button>
              </div>
              -->
          </div>
        </div>
      </table>
      <div *ngIf="searching" class="col-md-12 records-not-found">
        <p>
          <small>
            Aguarde...
          </small>
        </p>
      </div>
    </mat-card>
  </div>
</div>
